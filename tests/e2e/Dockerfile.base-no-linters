# Base image WITHOUT linters - for testing graceful degradation
# This image has cmc CLI but no ESLint or Ruff installed
#
# Build with: docker build -t cmc-e2e-base-no-linters -f tests/e2e/Dockerfile.base-no-linters .
FROM node:20-slim

# Install git and SSH client (no Python, no Ruff)
RUN apt-get update && apt-get install -y \
    git \
    openssh-client \
    && rm -rf /var/lib/apt/lists/*

# Configure SSH for github.com
RUN mkdir -p /root/.ssh && \
    ssh-keyscan github.com >> /root/.ssh/known_hosts

WORKDIR /cmc

# Copy package files
COPY package*.json ./

# Install dependencies BUT remove eslint after to simulate "no eslint"
RUN npm ci

# Copy source and build
COPY tsconfig.json ./
COPY src/ ./src/
RUN npm run build

# Remove ESLint to test graceful degradation
RUN rm -rf /cmc/node_modules/eslint /cmc/node_modules/@eslint /cmc/node_modules/typescript-eslint

# Default working directory for test projects
WORKDIR /project

# Symlink node_modules from cmc
RUN ln -s /cmc/node_modules ./node_modules

ENTRYPOINT ["node", "/cmc/dist/cli/index.js"]
