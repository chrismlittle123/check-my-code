# Shared base image for e2e tests
# This image contains the built cmc CLI, ESLint, Ruff, and all dependencies
#
# Build with: docker build -t cmc-e2e-base -f tests/e2e/Dockerfile.base .
FROM python:3.12-slim

# Install Node.js, git, and SSH client
RUN apt-get update && apt-get install -y \
    curl \
    git \
    openssh-client \
    && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Configure SSH for github.com
RUN mkdir -p /root/.ssh && \
    ssh-keyscan github.com >> /root/.ssh/known_hosts

# Install Ruff
RUN pip install --no-cache-dir ruff

WORKDIR /cmc

# Copy package files and install dependencies (includes ESLint)
COPY package*.json ./
RUN npm ci

# Copy source and build
COPY tsconfig.json ./
COPY src/ ./src/
RUN npm run build

# Default working directory for test projects
WORKDIR /project

# Symlink node_modules from cmc (includes ESLint)
RUN ln -s /cmc/node_modules ./node_modules

ENTRYPOINT ["node", "/cmc/dist/cli/index.js"]
