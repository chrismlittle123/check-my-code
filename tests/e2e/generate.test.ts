/**
 * E2E tests for `cmc generate` command
 */

import { describe, it, expect } from 'vitest';
import { run } from './runner.js';

describe('cmc generate eslint', () => {
  it('generates valid ESLint config with --stdout', async () => {
    const result = await run('check/typescript/default', ['generate', 'eslint', '--stdout']);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('// Generated by cmc (check-my-code)');
    expect(result.stdout).toContain("import js from '@eslint/js'");
    expect(result.stdout).toContain('tseslint.config(');
  });

  it('includes rules from cmc.toml', async () => {
    const result = await run('check/typescript/default', ['generate', 'eslint', '--stdout']);

    expect(result.stdout).toContain('"no-var": "error"');
    expect(result.stdout).toContain('"prefer-const": "error"');
    expect(result.stdout).toContain('"eqeqeq"');
  });

  it('generates complete ESLint config structure', async () => {
    // Use --stdout to avoid file system side effects
    const result = await run('check/typescript/default', ['generate', 'eslint', '--stdout']);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('export default');
    expect(result.stdout).toContain('tseslint.config(');
    expect(result.stdout).toContain('rules:');
  });
});

describe('cmc generate ruff', () => {
  it('generates valid Ruff config with --stdout', async () => {
    const result = await run('check/typescript/default', ['generate', 'ruff', '--stdout']);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('# Generated by cmc (check-my-code)');
    expect(result.stdout).toContain('line-length = 100');
    expect(result.stdout).toContain('[lint]');
  });

  it('includes lint rules from cmc.toml', async () => {
    const result = await run('check/typescript/default', ['generate', 'ruff', '--stdout']);

    expect(result.stdout).toContain('select = ["E","F","I"]');
    expect(result.stdout).toContain('ignore = ["E501"]');
  });
});

describe('cmc generate - error handling', () => {
  it('fails with exit code 3 for unknown linter', async () => {
    const result = await run('check/typescript/default', ['generate', 'unknown']);

    expect(result.exitCode).toBe(3);
    expect(result.stderr).toContain('Unknown linter');
  });

  it('is case insensitive for linter name', async () => {
    const result = await run('check/typescript/default', ['generate', 'ESLINT', '--stdout']);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('// Generated by cmc');
  });
});

describe('cmc generate - --force flag', () => {
  it('fails when ESLint config exists without --force', async () => {
    const result = await run('generate/existing-config', ['generate', 'eslint']);

    expect(result.exitCode).toBe(2);
    expect(result.stderr).toContain('already exists');
  });

  it('fails when Ruff config exists without --force', async () => {
    const result = await run('generate/existing-config', ['generate', 'ruff']);

    expect(result.exitCode).toBe(2);
    expect(result.stderr).toContain('already exists');
  });

  it('can generate ESLint config with --stdout when config exists', async () => {
    // Use --stdout to avoid file system side effects
    const result = await run('generate/existing-config', ['generate', 'eslint', '--stdout']);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('// Generated by cmc');
  });

  it('generates config with --stdout even when config exists', async () => {
    // Using --stdout avoids file system side effects
    const result = await run('generate/fresh', ['generate', 'eslint', '--stdout']);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('// Generated by cmc');
  });

  it('--stdout bypasses file existence check', async () => {
    const result = await run('generate/existing-config', ['generate', 'eslint', '--stdout']);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('// Generated by cmc');
  });
});

describe('cmc generate - empty rulesets', () => {
  it('handles ESLint generation with no rules defined', async () => {
    const result = await run('generate/empty-ruleset', ['generate', 'eslint', '--stdout']);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('// Generated by cmc');
    expect(result.stdout).toContain('rules:');
  });

  it('handles Ruff generation with no config defined', async () => {
    const result = await run('generate/empty-ruleset', ['generate', 'ruff', '--stdout']);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('# Generated by cmc');
  });
});
