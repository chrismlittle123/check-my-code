/**
 * E2E tests for `cmc generate` command
 */

import { describe, it, expect } from 'vitest';
import { runInDocker } from './docker-runner.js';
import { dockerAvailable, images, setupImages } from './setup.js';

// Setup: Build required images
setupImages(['check/typescript/default', 'generate/existing-config', 'generate/fresh']);

// =============================================================================
// Generate: ESLint config
// =============================================================================
describe.skipIf(!dockerAvailable)('cmc generate eslint', () => {
  it('generates valid ESLint config with --stdout', async () => {
    const result = await runInDocker(images['check/typescript/default'], [
      'generate',
      'eslint',
      '--stdout',
    ]);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('// Generated by cmc (check-my-code)');
    expect(result.stdout).toContain("import js from '@eslint/js'");
    expect(result.stdout).toContain('tseslint.config(');
  }, 30000);

  it('includes rules from cmc.toml', async () => {
    const result = await runInDocker(images['check/typescript/default'], [
      'generate',
      'eslint',
      '--stdout',
    ]);

    expect(result.stdout).toContain('"no-var": "error"');
    expect(result.stdout).toContain('"prefer-const": "error"');
    expect(result.stdout).toContain('"eqeqeq"');
  }, 30000);

  it('writes file and reports success', async () => {
    // Note: This modifies the container filesystem (ephemeral)
    const result = await runInDocker(images['check/typescript/default'], [
      'generate',
      'eslint',
      '--force',
    ]);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('Generated eslint.config.js');
  }, 30000);
});

// =============================================================================
// Generate: Ruff config
// =============================================================================
describe.skipIf(!dockerAvailable)('cmc generate ruff', () => {
  it('generates valid Ruff config with --stdout', async () => {
    const result = await runInDocker(images['check/typescript/default'], [
      'generate',
      'ruff',
      '--stdout',
    ]);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('# Generated by cmc (check-my-code)');
    expect(result.stdout).toContain('line-length = 100');
    expect(result.stdout).toContain('[lint]');
  }, 30000);

  it('includes lint rules from cmc.toml', async () => {
    const result = await runInDocker(images['check/typescript/default'], [
      'generate',
      'ruff',
      '--stdout',
    ]);

    expect(result.stdout).toContain('select = ["E","F","I"]');
    expect(result.stdout).toContain('ignore = ["E501"]');
  }, 30000);
});

// =============================================================================
// Generate: Error handling
// =============================================================================
describe.skipIf(!dockerAvailable)('cmc generate - error handling', () => {
  it('fails with exit code 3 for unknown linter', async () => {
    const result = await runInDocker(images['check/typescript/default'], ['generate', 'unknown']);

    expect(result.exitCode).toBe(3);
    expect(result.stderr).toContain('Unknown linter');
  }, 30000);

  it('is case insensitive for linter name', async () => {
    const result = await runInDocker(images['check/typescript/default'], [
      'generate',
      'ESLINT',
      '--stdout',
    ]);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('// Generated by cmc');
  }, 30000);
});

// =============================================================================
// Generate: --force flag behavior
// =============================================================================
describe.skipIf(!dockerAvailable)('cmc generate - --force flag', () => {
  it('fails when ESLint config exists without --force', async () => {
    const result = await runInDocker(images['generate/existing-config'], ['generate', 'eslint']);

    expect(result.exitCode).toBe(2); // CONFIG_ERROR
    expect(result.stderr).toContain('already exists');
  }, 30000);

  it('fails when Ruff config exists without --force', async () => {
    const result = await runInDocker(images['generate/existing-config'], ['generate', 'ruff']);

    expect(result.exitCode).toBe(2); // CONFIG_ERROR
    expect(result.stderr).toContain('already exists');
  }, 30000);

  it('overwrites ESLint config with --force', async () => {
    const result = await runInDocker(images['generate/existing-config'], [
      'generate',
      'eslint',
      '--force',
    ]);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('Generated eslint.config.js');
  }, 30000);

  it('overwrites Ruff config with --force', async () => {
    const result = await runInDocker(images['generate/existing-config'], [
      'generate',
      'ruff',
      '--force',
    ]);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('Generated ruff.toml');
  }, 30000);

  it('succeeds without --force when no config exists', async () => {
    const result = await runInDocker(images['generate/fresh'], ['generate', 'eslint']);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('Generated eslint.config.js');
  }, 30000);

  it('--stdout bypasses file existence check', async () => {
    const result = await runInDocker(images['generate/existing-config'], [
      'generate',
      'eslint',
      '--stdout',
    ]);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('// Generated by cmc');
  }, 30000);
});

// =============================================================================
// Generate: Complex rule values
// =============================================================================
describe.skipIf(!dockerAvailable)('cmc generate - complex rules', () => {
  it('handles array-style ESLint rules', async () => {
    // cmc.toml has: "eqeqeq" = ["error", "always"]
    const result = await runInDocker(images['check/typescript/default'], [
      'generate',
      'eslint',
      '--stdout',
    ]);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('"eqeqeq"');
    // Should have the array format
    expect(result.stdout).toMatch(/eqeqeq.*\[/);
  }, 30000);

  it('generates all Ruff lint sections', async () => {
    const result = await runInDocker(images['generate/fresh'], ['generate', 'ruff', '--stdout']);

    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('line-length = 120');
    expect(result.stdout).toContain('[lint]');
    expect(result.stdout).toContain('select =');
    expect(result.stdout).toContain('ignore =');
  }, 30000);
});
