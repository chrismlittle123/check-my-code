name: Daily Backup

on:
  schedule:
    # Run at midnight UTC every day
    - cron: "0 0 * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for complete backup

      - name: Setup SSH for backup repo
        env:
          BACKUP_DEPLOY_KEY: ${{ secrets.BACKUP_DEPLOY_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "${BACKUP_DEPLOY_KEY}" > ~/.ssh/backup_key
          chmod 600 ~/.ssh/backup_key
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          # Configure SSH to use this key for the backup repo
          cat >> ~/.ssh/config << EOF
          Host github-backup
            HostName github.com
            User git
            IdentityFile ~/.ssh/backup_key
            IdentitiesOnly yes
          EOF

      - name: Mirror repository
        run: |
          # Full mirror push - this is the primary backup mechanism
          # It preserves all branches, tags, and complete history
          git remote add backup git@github-backup:chrismlittle123/check-my-code-backup.git
          git push backup --mirror --force
          echo "BACKUP_DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV

      - name: Tag the backup
        run: |
          # Create a dated tag in the backup repo for easy reference
          git clone git@github-backup:chrismlittle123/check-my-code-backup.git backup-repo
          cd backup-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Create lightweight tag for this backup
          git tag -f "backup-${BACKUP_DATE}" HEAD
          git push origin "backup-${BACKUP_DATE}" --force || true
